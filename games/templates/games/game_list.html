{% extends "base.html" %}
{% load tz %}
{% load static %}

{% block title %}è³½ç¨‹{% endblock %}

{% block content %}
<h3 class="mb-3">ğŸ“… è³½ç¨‹</h3>

<div class="row g-3">
  <!-- Upcoming -->
  <div class="col-12 col-lg-6">
    <div class="card p-3 h-100">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">â³ å³å°‡é–‹è³½ / é€²è¡Œä¸­</h5>
        <span class="text-muted small">é¡¯ç¤ºæœ€å¤š 200 å ´</span>
      </div>

      <div class="table-responsive mt-3">
        <table class="table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th style="width:140px;">æ™‚é–“</th>
              <th>å°æˆ°</th>
              <th style="width:110px;">ç‹€æ…‹</th>
              <th class="text-end" style="width:90px;"></th>
            </tr>
          </thead>
          <tbody>
          {% for g in upcoming %}
            <tr>
              <td class="text-muted small text-nowrap">
                {{ g.start_time|localtime|date:"Y/m/d H:i" }}
              </td>

              <td>
                <div class="d-flex align-items-center gap-2 flex-wrap">
                  <!-- Away -->
                  <div class="d-flex align-items-center gap-2">
                    <img
                      class="team-logo"
                      src="{% static 'team_logos/' %}{{ g.away_team.abbr|upper }}.svg"
                      data-fallback="{% if g.away_team.logo_url %}{{ g.away_team.logo_url }}{% endif %}"
                      style="height:20px;width:auto"
                      alt="{{ g.away_team.name }}"
                    >
                    <span class="fw-semibold">{{ g.away_team.abbr|default:g.away_team.name }}</span>
                  </div>

                  <span class="text-muted mx-1">@</span>

                  <!-- Home -->
                  <div class="d-flex align-items-center gap-2">
                    <img
                      class="team-logo"
                      src="{% static 'team_logos/' %}{{ g.home_team.abbr|upper }}.svg"
                      data-fallback="{% if g.home_team.logo_url %}{{ g.home_team.logo_url }}{% endif %}"
                      style="height:20px;width:auto"
                      alt="{{ g.home_team.name }}"
                    >
                    <span class="fw-semibold">{{ g.home_team.abbr|default:g.home_team.name }}</span>
                  </div>
                </div>
              </td>

              <td>
                {% if g.status == "scheduled" %}
                  <span class="badge bg-secondary">Scheduled</span>
                {% elif g.status == "in_progress" %}
                  <span class="badge bg-warning text-dark">In Progress</span>
                {% elif g.status == "final" %}
                  <span class="badge bg-success">Final</span>
                {% else %}
                  <span class="badge bg-dark">Unknown</span>
                {% endif %}
              </td>

              <td class="text-end">
                <a class="btn btn-sm btn-accent" href="{% url 'games:detail' g.id %}">è©³æƒ…</a>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="4" class="text-muted">æ²’æœ‰å³å°‡é–‹è³½çš„æ¯”è³½ï¼ˆå…ˆè·‘ sync_scores_espnï¼‰</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Recent -->
  <div class="col-12 col-lg-6">
    <div class="card p-3 h-100">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">âœ… æœ€è¿‘å®Œè³½</h5>
        <span class="text-muted small">é¡¯ç¤ºæœ€å¤š 200 å ´</span>
      </div>

      <div class="table-responsive mt-3">
        <table class="table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th style="width:140px;">æ™‚é–“</th>
              <th>å°æˆ°</th>
              <th style="width:120px;">æ¯”åˆ†</th>
              <th class="text-end" style="width:90px;"></th>
            </tr>
          </thead>
          <tbody>
          {% for g in recent %}
            <tr>
              <td class="text-muted small text-nowrap">
                {{ g.start_time|localtime|date:"m/d H:i" }}
              </td>

              <td>
                <div class="d-flex align-items-center gap-2 flex-wrap">
                  <!-- Away -->
                  <div class="d-flex align-items-center gap-2">
                    <img
                      class="team-logo"
                      src="{% static 'team_logos/' %}{{ g.away_team.abbr|upper }}.svg"
                      data-fallback="{% if g.away_team.logo_url %}{{ g.away_team.logo_url }}{% endif %}"
                      style="height:20px;width:auto"
                      alt="{{ g.away_team.name }}"
                    >
                    <span class="fw-semibold">{{ g.away_team.abbr|default:g.away_team.name }}</span>
                  </div>

                  <span class="text-muted mx-1">@</span>

                  <!-- Home -->
                  <div class="d-flex align-items-center gap-2">
                    <img
                      class="team-logo"
                      src="{% static 'team_logos/' %}{{ g.home_team.abbr|upper }}.svg"
                      data-fallback="{% if g.home_team.logo_url %}{{ g.home_team.logo_url }}{% endif %}"
                      style="height:20px;width:auto"
                      alt="{{ g.home_team.name }}"
                    >
                    <span class="fw-semibold">{{ g.home_team.abbr|default:g.home_team.name }}</span>
                  </div>
                </div>
              </td>

              <td class="text-nowrap">
                {{ g.away_score }} - {{ g.home_score }}
              </td>

              <td class="text-end">
                <a class="btn btn-sm btn-ghost" href="{% url 'games:detail' g.id %}">è©³æƒ…</a>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="4" class="text-muted">å°šç„¡å®Œè³½è³‡æ–™</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  // âœ… ä¸€æ¬¡è™•ç†æ‰€æœ‰ logoï¼šæœ¬åœ° svg å¤±æ•— -> ç”¨ fallback URLï¼›éƒ½æ²’æœ‰ -> éš±è—
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("img.team-logo").forEach((img) => {
      img.addEventListener("error", () => {
        const fb = img.dataset.fallback || "";
        if (fb) {
          img.src = fb;
        } else {
          img.style.display = "none";
        }
      }, { once: true });
    });
  });
</script>

{% endblock %}
